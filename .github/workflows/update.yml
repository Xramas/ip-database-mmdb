name: Update IP Databases

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Output Directory
        run: mkdir -p output

      # ----------------------------------------------------------------
      # 1. IPinfo (Curl with User-Agent)
      # ----------------------------------------------------------------
      - name: Download IPinfo
        run: |
          echo "Downloading IPinfo..."
          curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -o output/ipinfo_lite.mmdb \
            "https://ipinfo.io/data/ipinfo_lite.mmdb?_src=frontend&token=${{ secrets.IPINFO_TOKEN }}"
          echo "IPinfo downloaded."

      # ----------------------------------------------------------------
      # 2. DB-IP (Smart Date Fallback)
      # ----------------------------------------------------------------
      - name: Download DB-IP
        run: |
          CURRENT_MONTH=$(date +%Y-%m)
          PREV_MONTH=$(date -d "last month" +%Y-%m)
          declare -a types=("asn" "city" "country")
          
          for type in "${types[@]}"; do
            FILENAME="dbip-${type}-lite"
            URL_CURRENT="https://download.db-ip.com/free/${FILENAME}-${CURRENT_MONTH}.mmdb.gz"
            URL_PREV="https://download.db-ip.com/free/${FILENAME}-${PREV_MONTH}.mmdb.gz"
            
            echo "Processing DB-IP $type..."
            if curl --output /dev/null --silent --head --fail "$URL_CURRENT"; then
              curl -s -L -o "output/${FILENAME}.mmdb.gz" "$URL_CURRENT"
            else
              echo "Trying previous month..."
              curl -s -L -o "output/${FILENAME}.mmdb.gz" "$URL_PREV"
            fi

            if [ -f "output/${FILENAME}.mmdb.gz" ]; then
              gunzip -f "output/${FILENAME}.mmdb.gz"
            fi
          done

      # ----------------------------------------------------------------
      # 3. MaxMind GeoLite2 (High Failure Risk - Isolated)
      # 使用 Curl + Browser UA 尝试绕过 451，并允许失败
      # ----------------------------------------------------------------
      - name: Download MaxMind
        continue-on-error: true # 关键：如果 MaxMind 451 报错，不中断后续步骤
        run: |
          declare -a editions=("GeoLite2-ASN" "GeoLite2-City" "GeoLite2-Country")
          
          for edition in "${editions[@]}"; do
            echo "Processing MaxMind $edition..."
            
            # 使用 Curl 模拟浏览器 User-Agent
            HTTP_CODE=$(curl -s -L -w "%{http_code}" -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              -o "${edition}.tar.gz" \
              "https://download.maxmind.com/app/geoip_download?edition_id=${edition}&license_key=${{ secrets.MAXMIND_TOKEN }}&suffix=tar.gz")
            
            if [ "$HTTP_CODE" == "200" ]; then
              echo "Download success for $edition."
              # 解压
              mkdir -p temp_extract
              tar -xzf "${edition}.tar.gz" -C temp_extract
              find temp_extract -name "*.mmdb" -exec mv {} output/ \;
              rm -rf temp_extract "${edition}.tar.gz"
            else
              echo "Failed to download $edition. HTTP Code: $HTTP_CODE (Likely blocked by MaxMind)"
              # 删除可能的空文件
              rm -f "${edition}.tar.gz"
            fi
          done

      # ----------------------------------------------------------------
      # 4. IP2Location
      # ----------------------------------------------------------------
      - name: Download IP2Location
        continue-on-error: true
        run: |
          CODE="DB11.LITE.BIN"
          echo "Downloading IP2Location $CODE..."
          curl -s -L -o "ip2location.zip" "https://www.ip2location.com/download/?token=${{ secrets.IP2LOCATION_TOKEN }}&file=$CODE"
          
          if [ -f "ip2location.zip" ]; then
            unzip -o ip2location.zip -d output/ || echo "Unzip failed, maybe token expired?"
            rm -f ip2location.zip
          fi

      # ----------------------------------------------------------------
      # 5. 清理与发布
      # ----------------------------------------------------------------
      - name: Delete Older Releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 30
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Release Tag
        id: tag
        run: echo "release_tag=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: IP Database Update ${{ steps.tag.outputs.release_tag }}
          files: output/*
          body: |
            Automatic daily update.
            Sources: IPinfo, DB-IP, MaxMind, IP2Location.
            (Note: Some sources might be missing if upstream blocked the download)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
